package climkit

import (
	"encoding/json"
	"github.com/rs/zerolog/log"
	"time"
)

type Climkit struct {
	api     *ClimkitAPI
	options ClientOptions
}

func New(options *ClientOptions) Climkit {
	return Climkit{
		options: *options,
		api:     NewApi(options),
	}
}

func (c *Climkit) GetAll() error {
	installations, err := c.api.GetInstallations()
	if err != nil {

		return err
	}
	log.Info().Strs("installations", installations).Msg("installations retrieved")

	for i := range installations {
		info, err := c.api.getInstallationInfo(installations[i])
		if err != nil {
			return err
		}
		infoStr, _ := json.Marshal(info)
		log.Info().RawJSON("info", infoStr).Msg("got installation info")

		meters, err := c.api.getMetersInfos(installations[i])
		metersStr, _ := json.Marshal(meters)
		log.Info().RawJSON("meters", metersStr).Msg("got installation meters")

		timeSeries, err := c.api.getMeterData(installations[i], meters, Electricity, time.Now().Add(-time.Minute*30))
		timeSeriesStr, _ := json.Marshal(timeSeries)
		log.Info().RawJSON("timeSeries", timeSeriesStr).Msg("got data")
	}
	return nil
}
